<!DOCTYPE html>
<html lang="en">
    <head>
        <!--
            This file was generated from 2010/hg-in-zsh.md.
            Do not edit manually.
        -->
        <meta charset="utf-8" />
        <meta name="generator" content="pandoc" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />

                <meta name="date" content="2010-05-24" />
        
                <meta name="category" content="computing, unix, zsh, mercurial" />
        
        <title>Mercurial Info in Your Zsh Prompt</title>

                <meta name="description" content="Zsh’s built-in vcs_info system is an amazing, flexible, and extendable system for putting Mercurial information in your shell prompt.">
        
        
                <link rel="stylesheet" href="../base.css">
        
        
            </head>
    <body>
        <div class="documentwrapper">
        <p class="index">
            <a href="/">Home</a>
            | <a href="/years.html">Posts by Year</a>
            | <a href="/categories.html">Posts by Category</a>
        </p>
                <p class="date">2010-05-24</p>
        
        <h1 id="mercurial-info-in-your-zsh-prompt">Mercurial Info in Your Zsh Prompt</h1>
        <p>See also: <a href="./git-in-zsh.html">Git in Zsh</a></p>
        <h2 id="what-is-vcs_info">What is <code>VCS_Info</code>?</h2>
        <p>If you aren’t already familiar with <code>VCS_Info</code> in Zsh, fire up your favorite manpage viewer and read through the section in zshcontrib(1). It allows you to pull information out of a version-controlled repository and display that in your shell prompt.</p>
        <p>The big win for <code>VCS_Info</code> over other, similar solutions is that it is built right into Zsh and supports Bazaar, Codeville, CVS, Darcs, Git, GNU arch, GNU quilt, Mercurial, Monotone, Perforce, Subversion, and SVK all using the same configuration. You put it into your prompt once then as you cd between your favorite git, hg, bzr, or svn local clones it Just Works®:</p>
        <p>Mercurial (using <a href="http://hg-git.github.com/">hg-git</a>):</p>
        <figure>
        <img src="./vcs-hggit.png" alt="image" /><figcaption>image</figcaption>
        </figure>
        <p>Git:</p>
        <figure>
        <img src="./vcs-git.png" alt="image" /><figcaption>image</figcaption>
        </figure>
        <p>It is also highly customizable.</p>
        <h3 id="vcs_info-quickstart"><code>VCS_Info</code> quickstart</h3>
        <ol type="1">
        <li><p>Put the following in your <code>~/.zshrc</code>:</p>
        <pre><code>autoload -Uz vcs_info
        zstyle &#39;:vcs_info:*&#39; enable hg git bzr svn</code></pre></li>
        <li>Put ${vcs_info_msg_0_} somewhere in your $PS1.</li>
        <li><p>Test it by going into a local repository directory. Your prompt should look something like this:</p>
        <pre><code>you@host ~/src/yourcode  (hg)-[default]-
        %</code></pre></li>
        <li><p>Be amazed and suddenly feel compelled to send <a href="http://bewatermyfriend.org">Frank Terbeck</a> a valentine to say thanks for writing <code>VCS_Info</code>.</p></li>
        </ol>
        <h2 id="vcs_info-mercurial-support"><code>VCS_Info</code> Mercurial Support</h2>
        <p>The first iteration of the Mercurial <code>VCS_Info</code> backend would display the changeset ID, local revision number, current branch, and the topmost applied <a href="http://mercurial.selenic.com/wiki/MqExtension">mq</a> patch. Here are the new features:</p>
        <div class="warning">
        <div class="admonition-title">
        <p>Warning</p>
        </div>
        <p>Many features in <code>VCS_Info</code> are disabled by default for performance reasons. Most of the below styles require customizing your <code>formats</code> and <code>actionformats</code> zstyles at least. Look at my customizations below and give zshcontrib(1) a read before you give up or complain.</p>
        </div>
        <h3 id="support-for-the-bookmarks-extension">Support for the Bookmarks extension</h3>
        <p>Enable Mercurial <a href="http://mercurial.selenic.com/wiki/BookmarksExtension">bookmarks</a> by adding the style:</p>
        <pre><code>zstyle &#39;:vcs_info:hg*:*&#39; get-bookmarks true</code></pre>
        <figure>
        <img src="./vcs-bookmarks.png" alt="image" /><figcaption>image</figcaption>
        </figure>
        <h3 id="show-marker-for-changes-in-the-working-directory">Show marker for changes in the working directory</h3>
        <p>Knowing if there are changes in your working directory at a glance can be a huge time saver:</p>
        <pre><code>zstyle &#39;:vcs_info:hg*:*&#39; check-for-changes true</code></pre>
        <figure>
        <img src="./vcs-changes.png" alt="image" /><figcaption>image</figcaption>
        </figure>
        <h3 id="avoid-the-overhead-of-starting-the-python-interpreter">Avoid the overhead of starting the Python interpreter</h3>
        <p>In very large repositories or on very slow computers, invoking Mercurial every time the prompt is drawn can simply be too slow. You can optionally use the hexdump program to fetch the changeset ID instead which is lightning fast.</p>
        <p>For example, the NetBeans repository is 3 GB in size so to enable fast lookup for just that directory:</p>
        <pre><code>zstyle &#39;:vcs_info:hg*:netbeans&#39; use-simple true</code></pre>
        <p>Here are three time tests in the NetBeans repo to give you an idea of the speed difference. Note that by specifying the current revision with <code>-r .</code> causes Mercurial to ignore the state of the working directory which goes a little faster but doesn’t look for changes.</p>
        <figure>
        <img src="./vcs-hexdump.png" alt="image" /><figcaption>image</figcaption>
        </figure>
        <div class="note">
        <div class="admonition-title">
        <p>Note</p>
        </div>
        <p>You cannot retrieve the local revision number with hexdump.</p>
        </div>
        <h3 id="display-the-current-action">Display the current action</h3>
        <p>Show when rebasing or merging. Define <code>actionformats</code>:</p>
        <pre><code>zstyle &#39;:vcs_info:hg*&#39; actionformats &quot;(%s|%a)[%i%u %b %m]&quot;</code></pre>
        <figure>
        <img src="./vcs-merging.png" alt="image" /><figcaption>image</figcaption>
        </figure>
        <h3 id="display-both-parents-during-a-merge">Display both parents during a merge</h3>
        <p>Mercurial separates multiple parents with a <code>+</code> by default:</p>
        <figure>
        <img src="./vcs-merging.png" alt="image" /><figcaption>image</figcaption>
        </figure>
        <p>This doesn’t (currently) work with the <code>use-simple</code> setting, although I think the second parent hash is available with hexdump so this may be added in the future.</p>
        <h3 id="detection-for-hg-git-hgsubversion-and-hgsvn">Detection for <a href="http://hg-git.github.com/">hg-git</a>, <a href="http://www.bitbucket.org/durin42/hgsubversion/">hgsubversion</a>, and <a href="http://pypi.python.org/pypi/hgsvn/">hgsvn</a></h3>
        <p>It can be useful to see when you are in a repo created from another VCS since your workflow is often altered.</p>
        <figure>
        <img src="./vcs-hggit.png" alt="image" /><figcaption>image</figcaption>
        </figure>
        <h3 id="improved-mq-display">Improved <a href="http://mercurial.selenic.com/wiki/MqExtension">mq</a> display</h3>
        <p>Show the names and count of both applied and unapplied patches. <code>VCS_Info</code> supports this same configuration for <a href="http://www.procode.org/stgit/">stgit</a> and <a href="http://savannah.nongnu.org/projects/quilt">Quilt</a> as well.</p>
        <figure>
        <img src="./vcs-mq.png" alt="image" /><figcaption>image</figcaption>
        </figure>
        <h3 id="support-for-mq-guards">Support for <a href="http://mercurial.selenic.com/wiki/MqExtension">mq</a> guards</h3>
        <p>The unapplied count now takes <a href="http://hgbook.red-bean.com/read/advanced-uses-of-mercurial-queues.html">guards</a> into account.</p>
        <figure>
        <img src="./vcs-guards.png" alt="image" /><figcaption>image</figcaption>
        </figure>
        <h2 id="vcs_info-hooks"><code>VCS_Info</code> Hooks</h2>
        <p>Hooks are a great and open-ended way to customize the output. The hooks documentation is really good and worth a read.</p>
        <p>For example, I wanted to add a marker to the display when I’m not currently on a branch head:</p>
        <figure>
        <img src="./vcs-notonbranchhead.png" alt="image" /><figcaption>image</figcaption>
        </figure>
        <p>The hook looks like this:</p>
        <pre><code>zstyle &#39;:vcs_info:hg*+set-message:*&#39; hooks hg-storerev hg-branchhead
        
        ### Store the localrev and global hash for use in other hooks
        function +vi-hg-storerev() {
            user_data[localrev]=${hook_com[localrev]}
            user_data[hash]=${hook_com[hash]}
        }
        
        ### Show marker when the working directory is not on a branch head
        # This may indicate that running `hg up` will do something
        function +vi-hg-branchhead() {
            local branchheadsfile i_tiphash i_branchname
            local -a branchheads
        
            local branchheadsfile=${hook_com[base]}/.hg/branchheads.cache
        
            # Bail out if any mq patches are applied
            [[ -s ${hook_com[base]}/.hg/patches/status ]] &amp;&amp; return 0
        
            if [[ -r ${branchheadsfile} ]] ; then
                while read -r i_tiphash i_branchname ; do
                    branchheads+=( $i_tiphash )
                done &lt; ${branchheadsfile}
        
                if [[ ! ${branchheads[(i)${user_data[hash]}]} -le ${#branchheads} ]] ; then
                    hook_com[revision]=&quot;${c4}^${c2}${hook_com[revision]}&quot;
                fi
            fi
        }</code></pre>
        <div class="note">
        <div class="admonition-title">
        <p>Note</p>
        </div>
        <p>The reason this functionality isn’t in the core backend is because the branchheads.cache isn’t updated with every hg operation so on occasion it will give a false positive. Most of the time it is Good Enough®.</p>
        </div>
        <h2 id="putting-it-all-together">Putting it All Together</h2>
        <p>You can pack quite a lot of information into your prompt (if you want to):</p>
        <figure>
        <img src="./vcs-complete.png" alt="image" /><figcaption>image</figcaption>
        </figure>
        <p>If you are interested, the entirely of my <code>VCS_Info</code> configuration is available on GitHub or BitBucket in my <a href="https://github.com/whiteinge/dotfiles/blob/master/.zsh_shouse_prompt">Zsh prompt file</a>.</p>
        <p>Here are the important lines (omitting hooks and colors). <code>hg*</code> ensures the same style is applied to <code>hg</code> as well as variants like <code>hg-git</code>, <code>hg-hgsubversion</code>, etc.:</p>
        <pre><code>zstyle &#39;:vcs_info:*&#39; enable hg git bzr svn
        zstyle &#39;:vcs_info:(hg*|git*):*&#39; get-revision true
        zstyle &#39;:vcs_info:(hg*|git*):*&#39; check-for-changes true
        
        # rev+changes branch misc
        zstyle &#39;:vcs_info:hg*&#39; formats &quot;(%s)[%i%u %b %m]&quot;
        zstyle &#39;:vcs_info:hg*&#39; actionformats &quot;(%s|%a)[%i%u %b %m]&quot;
        
        # hash changes branch misc
        zstyle &#39;:vcs_info:git*&#39; formats &quot;(%s)[%12.12i %u %b %m]&quot;
        zstyle &#39;:vcs_info:git*&#39; actionformats &quot;(%s|%a)[%12.12i %u %b %m]&quot;
        
        zstyle &#39;:vcs_info:hg*:netbeans&#39; use-simple true
        
        zstyle &#39;:vcs_info:hg*:*&#39; get-bookmarks true
        
        zstyle &#39;:vcs_info:hg*:*&#39; get-mq true
        zstyle &#39;:vcs_info:hg*:*&#39; get-unapplied true
        zstyle &#39;:vcs_info:hg*:*&#39; patch-format &quot;mq(%g):%n/%c %p&quot;
        zstyle &#39;:vcs_info:hg*:*&#39; nopatch-format &quot;mq(%g):%n/%c %p&quot;
        
        zstyle &#39;:vcs_info:hg*:*&#39; unstagedstr &quot;+&quot;
        zstyle &#39;:vcs_info:hg*:*&#39; hgrevformat &quot;%r&quot; # only show local rev.
        zstyle &#39;:vcs_info:hg*:*&#39; branchformat &quot;%b&quot; # only show branch</code></pre>
        <h2 id="dont-wait">Try the New Features Now!</h2>
        <p>These new features are still unreleased (as of Zsh 4.3.10). You don’t have to wait for the next release of Zsh to try them. Full instructions to keep a local checkout from CVS are located in the <a href="http://zsh.git.sourceforge.net/git/gitweb.cgi?p=zsh/zsh;a=blob;f=Misc/vcs_info-examples">vcs_info-examples file</a>.</p>
        <p><em>tl;dr</em>:</p>
        <ol type="1">
        <li>Download the <a href="http://zsh.git.sourceforge.net/git/gitweb.cgi?p=zsh/zsh;a=snapshot;sf=tgz">latest snapshot</a> tarball from the Git mirror and untar it.</li>
        <li>Put the <code>Functions/VCS_Info</code> directory from the archive somewhere. <code>~/.zfuncs</code> is a good place.</li>
        <li><p>Point your Zsh at that directory (requires extended_glob to be set):</p>
        <pre><code>fpath=( ~/.zfuncs ~/.zfuncs/VCS_Info/**/*~*/(CVS)#(/) $fpath )</code></pre></li>
        <li><p>Restart Zsh:</p>
        <pre><code>% exec zsh</code></pre></li>
        </ol>

                </div>
    </body>
</html>
